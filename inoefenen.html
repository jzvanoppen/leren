<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Woordjes Oefenen</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
    input,select,button{font-size:1rem;padding:8px;margin:6px 0}
    #quiz{display:none;margin-top:16px}
    .big{font-size:1.25rem}
    #resultaat{margin-top:8px}
    table,th,td{border:1px solid #444;border-collapse:collapse;padding:6px}
    th{background:#f0f0f0}
    .correct{color:green}
    .wrong{color:red}
    .hint{font-style:italic;color:#333}
    .inline{display:inline-block;margin-right:8px}
  </style>
</head>
<body>
  <a href="index.html">← Terug naar index</a>
  <h1>Woordjes Oefenen</h1>

  <label class="inline">Bestandsnaam (4 tekens):</label>
  <input id="fileInput" maxlength="4" placeholder="bv. iaab" />
  <br>
  <label class="inline">Hoeveel woorden oefenen?</label>
  <select id="limietSelect">
    <option value="0">Alles</option>
    <option value="10">10</option>
    <option value="15">15</option>
    <option value="20">20</option>
    <option value="25">25</option>
  </select>
  <br>
  <button id="startBtn" type="button" onclick="loadFile()">Start Oefenen</button>

  <div id="quiz" aria-live="polite">
    <p class="big" id="vraagNL"></p>
    <input id="antwoord" placeholder="Typ hier de vertaling en druk Enter" autocomplete="off" />
    <button id="controleerBtn" type="button">Controleer</button>
    <p id="resultaat"></p>
    <p id="score" class="hint"></p>
    <div id="einde" style="display:none;margin-top:12px"></div>
  </div>

  <h2>Overzicht Tekstbestanden</h2>
  <p>Voeg rijen toe met "Bestand" (zonder .txt) en een korte beschrijving. AANTAL wordt automatisch bijgewerkt bij laden.</p>
  <table id="overzicht">
    <tr><th>Bestand</th><th>Aantal</th><th>Beschrijving</th></tr>
    <tr><td>iaab</td><td id="iaab-count">?</td><td>vervoegingen avoir en être</td></tr>
    <tr><td>iabq</td><td id="iabq-count">?</td><td>Chemische elementen KERST 2025-2026</td></tr>
    <tr><td>iabr</td><td id="iabr-count">?</td><td>Chemische elementen volledig</td></tr>
  </table>
  <button id="addRowBtn" type="button">Rij toevoegen</button>

  <p id="footer-note">Bestanden moeten zich bevinden in de map <code>txt/</code> en heten bijvoorbeeld <code>txt/iaab.txt</code>.<br>
  Formaat per regel: <code>nl:::fr:info</code> (bijv. <em>houden van:::aimer:INFINITIF</em>).</p>

<script>
(function(){
  // State
  let allSelected = [];
  let huidige = null;
  let stateByKey = {}; // nl -> {attempts, wrongs, done, pendingRepeat, waitingForRetype}
  let juist = 0, totaal = 0;

  const fileInput = document.getElementById('fileInput');
  const limSel = document.getElementById('limietSelect');
  const controleerBtn = document.getElementById('controleerBtn');
  const antwoord = document.getElementById('antwoord');
  const vraagNL = document.getElementById('vraagNL');
  const resultaat = document.getElementById('resultaat');
  const scoreEl = document.getElementById('score');
  const quiz = document.getElementById('quiz');
  const einde = document.getElementById('einde');

  // helpers
  function norm(s){ return (s||'').replace(/\s+/g,' ').trim().toLowerCase(); }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  function parseLine(line){
    // format: nl:::fr:info  (nl may contain colons)
    const idx = line.indexOf(':::');
    if(idx===-1) return null;
    const nl = line.slice(0,idx).trim();
    const rest = line.slice(idx+3);
    const parts = rest.split(':');
    const fr = (parts[0]||'').trim();
    const info = parts.slice(1).join(':').trim();
    if(!nl || !fr) return null;
    return {nl,fr,info};
  }

  // Load file
  window.loadFile = function(){
    const naam = (fileInput.value||'').trim();
    if(!/^[a-zA-Z0-9]{4}$/.test(naam)) { alert('Geef exact 4 letters/cijfers in.'); return; }
    const path = 'txt/' + naam + '.txt';

    fetch(path).then(r=>{
      if(!r.ok) throw new Error('notfound');
      return r.text();
    }).then(text=>{
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const parsed = lines.map(parseLine).filter(x=>x);
      if(parsed.length===0){ alert('Bestand bevat geen regels met het verwachte formaat nl:::fr:info'); return; }

      // update aantal cel
      const countCell = document.getElementById(naam + '-count');
      if(countCell) countCell.textContent = parsed.length;

      // apply limit (random sample)
      const lim = parseInt(limSel.value,10)||0;
      let pool = parsed.slice();
      if(lim>0 && lim < pool.length){ pool = shuffle(pool).slice(0, lim); }

      // init state
      allSelected = pool.map((w,i)=>Object.assign({},w,{_id:i}));
      stateByKey = {};
      allSelected.forEach(w=> stateByKey[w.nl] = {attempts:0,wrongs:0,done:false,pendingRepeat:false,waitingForRetype:false});
      juist = 0; totaal = 0;

      // show quiz
      quiz.style.display = 'block';
      einde.style.display = 'none';
      antwoord.value = '';
      antwoord.focus();
      nieuwWoord();
    }).catch(err=>{
      alert('Kon bestand ' + path + ' niet laden. Controleer map txt/ en bestandsnaam.');
    });
  };

  // pick active pool
  function pickActivePool(){ return allSelected.filter(w=> !stateByKey[w.nl].done); }

  function nieuwWoord(){
    const active = pickActivePool();
    if(active.length===0) return toonEinde();
    huidige = active[Math.floor(Math.random()*active.length)];
    const info = huidige.info? ' ('+escapeHtml(huidige.info)+')' : '';
    vraagNL.innerHTML = '<b>'+escapeHtml(huidige.nl)+'</b>' + info;
    resultaat.innerHTML = '';
    antwoord.value = '';
    antwoord.focus();
    updateScore();
  }

  // check answer
  function controleer(){
    if(!huidige) return;
    const key = huidige.nl;
    const st = stateByKey[key];
    const given = (antwoord.value||'').trim();
    if(given.length===0) return; // ignore empty

    // if waiting for retype
    if(st.waitingForRetype){
      totaal++;
      if(norm(given) === norm(huidige.fr)){
        st.attempts++;
        // after correct retype, mark pendingRepeat so word returns once more later
        if(!st.pendingRepeat) st.pendingRepeat = true;
        resultaat.innerHTML = '<span class="correct">Juist — je hebt het overgetypt.</span>';
        updateScore();
        st.waitingForRetype = false;
        setTimeout(nieuwWoord,700);
      } else {
        st.wrongs++; st.attempts++;
        resultaat.innerHTML = '<span class="wrong">Nog fout. Typ exact over: <b>'+escapeHtml(huidige.fr)+'</b></span>';
        updateScore();
        // remain waitingForRetype true so they must try again
        st.waitingForRetype = true;
      }
      return;
    }

    // normal first attempt
    totaal++;
    if(norm(given) === norm(huidige.fr)){
      // correct first time
      juist++;
      st.attempts++;
      // logic for repeats: if previously wrongs>0 and not pendingRepeat -> set pendingRepeat
      if(st.wrongs>0 && !st.pendingRepeat){ st.pendingRepeat = true; }
      else {
        if(st.wrongs===0) st.done = true; else { if(st.pendingRepeat) st.done = true; else st.pendingRepeat = true; }
      }
      resultaat.innerHTML = '<span class="correct">Juist!</span>';
      updateScore();
      setTimeout(nieuwWoord,700);
    } else {
      // wrong: show correct and require retype
      st.wrongs++; st.attempts++;
      resultaat.innerHTML = '<span class="wrong">Fout. Typ exact over: <b>'+escapeHtml(huidige.fr)+'</b></span>';
      st.waitingForRetype = true;
      updateScore();
    }
  }

  // update score display
  function updateScore(){ scoreEl.textContent = juist + '/' + totaal; }

  // end screen
  function toonEinde(){
    quiz.style.display = 'none';
    einde.style.display = 'block';
    let totalWords = allSelected.length;
    let html = '<h3>Eindscore: '+juist+'/'+totaal+'</h3>';
    html += '<p>Je oefende '+totalWords+' woorden.</p>';
    const wrongEntries = Object.entries(stateByKey).filter(([k,v])=> v.wrongs>0);
    if(wrongEntries.length===0) html += '<p>Geen fouten — goed gedaan!</p>';
    else{
      html += '<h4>Foute woorden (met juiste vertaling en aantal keer fout):</h4><ul>';
      wrongEntries.forEach(([nl,v])=>{
        const wrd = allSelected.find(w=> w.nl===nl) || {fr:'?'};
        html += '<li>' + escapeHtml(nl) + ' → ' + escapeHtml(wrd.fr) + ' (x' + v.wrongs + ')</li>';
      });
      html += '</ul>';
    }
    html += '<p><a href="index.html">Terug naar index</a></p>';
    einde.innerHTML = html;
  }

  // expose controleer to button and Enter
  controleerBtn.addEventListener('click', controleer);
  antwoord.addEventListener('keydown', function(e){ if(e.key==='Enter') controleer(); });

  // add row functionality
  document.getElementById('addRowBtn').addEventListener('click', function(){
    const tbl = document.getElementById('overzicht');
    const row = tbl.insertRow(-1);
    const a = row.insertCell(0); const b = row.insertCell(1); const c = row.insertCell(2);
    a.innerHTML = '<input maxlength="4" placeholder="bestandsnaam (4)" />';
    b.innerHTML = '<input placeholder="beschrijving" />';
    c.textContent = '?';
    const inputA = a.querySelector('input');
    inputA.addEventListener('blur', function(){ const name = this.value.trim(); if(/^[a-zA-Z0-9]{4}$/.test(name)){ c.id = name + '-count'; } });
  });

  // expose for debugging
  window._woords = {loadFile: loadFile, controleer: controleer};
})();
</script>
</body>
</html>

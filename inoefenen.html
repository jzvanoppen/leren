<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Woordjes Oefenen</title>
  <link rel="icon" type="image/png" href="img/favicon_F56565_192.png">
  <link rel="apple-touch-icon" href="img/favicon_F56565_192.png">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
    input,select,button{font-size:1rem;padding:8px;margin:6px 0}
    #quiz{display:none;margin-top:16px}
    .big{font-size:1.25rem}
    #resultaat{margin-top:8px}
    table,th,td{border:1px solid #444;border-collapse:collapse;padding:6px}
    th{background:#f0f0f0}
    .correct{color:green}
    .wrong{color:red}
    .hint{font-style:italic;color:#333}
    .inline{display:inline-block;margin-right:8px}
  </style>
</head>
<body>
  <h1>Woordjes Oefenen</h1>

  <label class="inline">Bestandsnaam (4 tekens):</label>
  <input id="fileInput" maxlength="4" placeholder="bv. iaab" />
  <br>
  <label class="inline">Hoeveel woorden oefenen?</label>
  <select id="limietSelect">
    <option value="0">Alles</option>
    <option value="10">10</option>
    <option value="15">15</option>
    <option value="20">20</option>
    <option value="25">25</option>
  </select>
  <br>
  <button id="startBtn" type="button" onclick="loadFile()">Start Oefenen</button>

  <div id="quiz" aria-live="polite">
    <p class="big" id="vraagNL"></p>
    <input id="antwoord" placeholder="Typ hier de vertaling en druk Enter" autocomplete="off" />
    <button id="controleerBtn" type="button">Controleer</button>
    <p id="resultaat"></p>
    <p id="score" class="hint"></p>
    <div id="einde" style="display:none;margin-top:12px"></div>
  </div>

<script>
(function(){
  let allSelected = [];
  let huidige = null;
  let stateByKey = {};
  let juist = 0, totaal = 0;

  const fileInput = document.getElementById('fileInput');
  const limSel = document.getElementById('limietSelect');
  const controleerBtn = document.getElementById('controleerBtn');
  const antwoord = document.getElementById('antwoord');
  const vraagNL = document.getElementById('vraagNL');
  const resultaat = document.getElementById('resultaat');
  const scoreEl = document.getElementById('score');
  const quiz = document.getElementById('quiz');
  const einde = document.getElementById('einde');

  function norm(s){ return (s||'').replace(/\s+/g,' ').trim().toLowerCase(); }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  /* ====== TEXT TO SPEECH TOEVOEGING ====== */
  function speak(text){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    if (/[àâçéèêëîïôûùüÿœæ]/i.test(text)) {
      u.lang = 'fr-FR';
    } else {
      u.lang = 'en-US';
    }
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
  /* ===================================== */

  function parseLine(line){
    const idx = line.indexOf(':::');
    if(idx===-1) return null;
    const nl = line.slice(0,idx).trim();
    const rest = line.slice(idx+3);
    const parts = rest.split(':');
    const fr = (parts[0]||'').trim();
    const info = parts.slice(1).join(':').trim();
    if(!nl || !fr) return null;
    return {nl,fr,info};
  }

  window.loadFile = function(){
    const naam = (fileInput.value||'').trim();
    if(!/^[a-zA-Z0-9]{4}$/.test(naam)) { alert('Geef exact 4 letters/cijfers in.'); return; }
    const path = 'txt/' + naam + '.txt';

    fetch(path).then(r=>{
      if(!r.ok) throw new Error();
      return r.text();
    }).then(text=>{
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const parsed = lines.map(parseLine).filter(x=>x);
      if(parsed.length===0){ alert('Geen geldige regels'); return; }

      allSelected = parsed.map((w,i)=>Object.assign({},w,{_id:i}));
      stateByKey = {};
      allSelected.forEach(w=> stateByKey[w.nl] = {wrongs:0,done:false,waiting:false});
      juist = 0; totaal = 0;

      quiz.style.display = 'block';
      nieuwWoord();
    }).catch(()=>alert('Bestand niet gevonden'));
  };

  function pickActive(){ return allSelected.filter(w=> !stateByKey[w.nl].done); }

  function nieuwWoord(){
    const active = pickActive();
    if(active.length===0) return toonEinde();
    huidige = active[Math.floor(Math.random()*active.length)];
    vraagNL.innerHTML = '<b>'+escapeHtml(huidige.nl)+'</b>';
    resultaat.innerHTML = '';
    antwoord.value = '';
    antwoord.focus();
    updateScore();
  }

  function controleer(){
    if(!huidige) return;
    const st = stateByKey[huidige.nl];
    const given = antwoord.value.trim();
    if(!given) return;

    totaal++;

    if(norm(given) === norm(huidige.fr)){
      juist++;
      resultaat.innerHTML = '<span class="correct">Juist!</span>';
      speak(huidige.fr);
      st.done = true;
      updateScore();
      setTimeout(nieuwWoord,700);
    } else {
      st.wrongs++;
      resultaat.innerHTML = '<span class="wrong">Fout. Juiste antwoord: <b>'+escapeHtml(huidige.fr)+'</b></span>';
      speak(huidige.fr);
      updateScore();
    }
  }

  function updateScore(){ scoreEl.textContent = juist + '/' + totaal; }

  function toonEinde(){
    quiz.style.display = 'none';
    einde.style.display = 'block';
    einde.innerHTML = '<h3>Eindscore: '+juist+'/'+totaal+'</h3>';
  }

  controleerBtn.addEventListener('click', controleer);
  antwoord.addEventListener('keydown', e=>{ if(e.key==='Enter') controleer(); });

})();
</script>
</body>
</html>
